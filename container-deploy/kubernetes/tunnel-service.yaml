# Kubernetes example: Expose cluster services via tunnel-rs
#
# Deploy tunnel-rs to expose internal ClusterIP services to remote peers.
# Uses client-initiated mode - one server can serve multiple services.
#
# This is an alternative to kubectl port-forward that:
#   - Supports UDP (kubectl port-forward doesn't)
#   - Works across NAT without kubectl access
#   - Can be left running persistently
#   - Allows clients to choose which service to access
#
# Note: Server uses CIDR notation to whitelist allowed networks (no ports).
#       Client uses hostnames with ports to specify what to connect to.
#
# Usage:
#   1. Create secrets for nostr keys:
#      kubectl create secret generic tunnel-nostr-keys \
#        --from-file=server.nsec=./server.nsec \
#        --from-literal=peer-npub=npub1...
#
#   2. Apply:
#      kubectl apply -f tunnel-service.yaml
#
#   3. On remote machine, connect to any service in allowed networks:
#      # Access postgres (client specifies hostname:port)
#      tunnel-rs client ice-nostr \
#        --source tcp://postgres.default.svc.cluster.local:5432 \
#        --target 127.0.0.1:5432 \
#        --nsec-file ./client.nsec \
#        --peer-npub <SERVER_NPUB>
#
#      # Access cluster DNS (UDP!)
#      tunnel-rs client ice-nostr \
#        --source udp://kube-dns.kube-system.svc.cluster.local:53 \
#        --target udp://127.0.0.1:5353 \
#        --nsec-file ./client.nsec \
#        --peer-npub <SERVER_NPUB>

apiVersion: apps/v1
kind: Deployment
metadata:
  name: tunnel-server
  labels:
    app: tunnel-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tunnel-server
  template:
    metadata:
      labels:
        app: tunnel-server
    spec:
      containers:
        - name: tunnel
          image: ghcr.io/andrewtheguy/tunnel-rs:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              exec tunnel-rs server ice-nostr \
                --allowed-tcp 10.0.0.0/8 \
                --allowed-udp 10.0.0.0/8 \
                --nsec-file /secrets/server.nsec \
                --peer-npub "$(cat /secrets/peer-npub)" \
                --max-sessions 20
          volumeMounts:
            - name: nostr-keys
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: nostr-keys
          secret:
            secretName: tunnel-nostr-keys
