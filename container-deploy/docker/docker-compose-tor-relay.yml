# Docker Compose: Self-hosted iroh-relay via Tor Hidden Service
#
# This setup runs your own iroh-relay as a Tor hidden service (.onion),
# eliminating the need for a public IP address or port forwarding.
#
# Use Case:
#   - Self-host relay infrastructure without exposing public IPs
#   - Works behind NAT, firewalls, or when Cloudflare tunnel fails
#   - Direct P2P connections bypass Tor (no performance impact)
#
# Architecture:
#   ┌─────────────────────────────────────────────────────────────┐
#   │  Client ──[Tor]──► .onion relay ◄──[Tor]── Server          │
#   │     │                                          │            │
#   │     └────────── Direct P2P (QUIC/UDP) ─────────┘            │
#   │                  (bypasses Tor entirely)                    │
#   └─────────────────────────────────────────────────────────────┘
#
# Setup:
#   1. Start the services:
#      docker compose -f docker-compose-tor-relay.yml up -d
#
#   2. Wait for Tor to generate the .onion address (30-60 seconds):
#      docker compose -f docker-compose-tor-relay.yml logs tor
#      # Look for: "Tor hidden service hostname: xxxxxxx.onion"
#
#   3. Get your .onion address:
#      docker compose -f docker-compose-tor-relay.yml exec tor cat /var/lib/tor/hidden_service/hostname
#
#   4. Get the server's EndpointId:
#      docker compose -f docker-compose-tor-relay.yml logs tunnel-server
#
#   5. On the client machine (requires local Tor daemon):
#      tor &  # Start Tor SOCKS5 proxy on 127.0.0.1:9050
#      tunnel-rs client iroh \
#        --relay-url http://YOUR_ADDRESS.onion \
#        --socks5-proxy socks5h://127.0.0.1:9050 \
#        --node-id <ENDPOINT_ID> \
#        --source tcp://nginx:80 \
#        --target 127.0.0.1:8080
#
#   6. Access the service at http://127.0.0.1:8080

services:
  # Tor daemon with hidden service
  tor:
    image: goldy/tor-hidden-service:latest
    environment:
      # Service name and port mapping: .onion:80 -> iroh-relay:3340
      IROH_RELAY_PORTS: "80:iroh-relay:3340"
    volumes:
      # Persist hidden service keys (optional but recommended)
      - tor-keys:/var/lib/tor/hidden_service
    depends_on:
      - iroh-relay
    healthcheck:
      test: ["CMD", "test", "-f", "/var/lib/tor/hidden_service/hostname"]
      interval: 10s
      timeout: 5s
      retries: 12

  # iroh-relay server (HTTP only - Tor provides encryption)
  iroh-relay:
    image: n0computer/iroh-relay:latest
    command:
      - --dev
    # Only accessible within Docker network (via Tor hidden service)
    expose:
      - "3340"

  # Example service to tunnel (replace with your actual service)
  nginx:
    image: nginx:alpine
    # No ports exposed - only accessible via tunnel

  # tunnel-rs server - connects to relay via Tor SOCKS5
  tunnel-server:
    image: ghcr.io/andrewtheguy/tunnel-rs:latest
    command:
      - server
      - iroh
      - --relay-url
      - http://iroh-relay:3340  # Direct connection within Docker network
      - --allowed-tcp
      - "172.16.0.0/12"  # Docker default network range
      - --allowed-tcp
      - "10.0.0.0/8"     # Alternative Docker network range
    volumes:
      # Optional: persistent identity
      # - ./server.key:/app/server.key:ro
    depends_on:
      tor:
        condition: service_healthy
      iroh-relay:
        condition: service_started
      nginx:
        condition: service_started

volumes:
  tor-keys:
