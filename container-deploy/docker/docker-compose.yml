# Docker Compose example: Expose internal services via tunnel-rs (multi-source iroh mode)
#
# This example shows how to use tunnel-rs to expose services running in Docker
# to a remote peer without opening ports on the host.
#
# Multi-source mode: The client specifies which service to connect to.
# The server allows access to any service in the configured network ranges.
#
# Setup:
#   1. Generate server key for stable EndpointId:
#      docker run --rm ghcr.io/andrewtheguy/tunnel-rs:latest \
#        generate-server-key --output - > server.key
#
#   2. Generate authentication token:
#      docker run --rm ghcr.io/andrewtheguy/tunnel-rs:latest \
#        generate-token > tokens.txt
#      # Share this token with authorized clients
#
#   3. Start the services:
#      docker compose up -d
#
#   4. Get the server EndpointId from logs:
#      docker compose logs tunnel-server | grep EndpointId
#
#   5. On the remote machine, connect to any service:
#      # Connect to web service
#      tunnel-rs client \
#        --server-node-id <SERVER_NODE_ID> \
#        --source tcp://web:80 \
#        --target 127.0.0.1:8080 \
#        --auth-token <AUTH_TOKEN>
#
#      # Connect to database
#      tunnel-rs client \
#        --server-node-id <SERVER_NODE_ID> \
#        --source tcp://db:5432 \
#        --target 127.0.0.1:5432 \
#        --auth-token <AUTH_TOKEN>
#
#   6. Access services at localhost

services:
  # Example web service
  web:
    image: nginx:alpine
    # No ports exposed - only accessible within Docker network

  # Example database service
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: example
    # No ports exposed - only accessible within Docker network

  # tunnel-rs server - exposes services to authenticated remote peers
  tunnel-server:
    image: ghcr.io/andrewtheguy/tunnel-rs:latest
    command:
      - server
      - --allowed-tcp
      - "172.16.0.0/12"  # Docker default network range
      - --allowed-tcp
      - "192.168.0.0/16" # Docker bridge networks
      - --secret-file
      - /secrets/server.key
      - --auth-tokens-file
      - /secrets/tokens.txt
    volumes:
      - ./server.key:/secrets/server.key:ro
      - ./tokens.txt:/secrets/tokens.txt:ro
    depends_on:
      - web
      - db
