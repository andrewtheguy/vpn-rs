# Docker Compose example: Expose internal services via tunnel-rs
#
# This example shows how to use tunnel-rs to expose services running in Docker
# to a remote peer without opening ports on the host.
#
# Usage:
#   1. Generate a persistent key (optional, for stable endpoint ID):
#      docker run --rm ghcr.io/andrewtheguy/tunnel-rs:latest generate-iroh-key --output - > server.key
#
#   2. Start the services:
#      docker compose up -d
#
#   3. Get the EndpointId from logs:
#      docker compose logs tunnel-server
#
#   4. On the remote machine, connect:
#      tunnel-rs client iroh --node-id <ENDPOINT_ID> --source tcp://web:80 --target 127.0.0.1:8080
#
#   5. Access the web service at http://127.0.0.1:8080

services:
  # Example web service (replace with your actual service)
  web:
    image: nginx:alpine
    # No ports exposed - only accessible within Docker network

  # tunnel-rs server - exposes services to remote peers
  tunnel-server:
    image: ghcr.io/andrewtheguy/tunnel-rs:latest
    command:
      - server
      - iroh
      - --allowed-tcp
      - "172.16.0.0/12"  # Docker default network range
    depends_on:
      - web
    # Optional: mount a persistent key for stable EndpointId
    # volumes:
    #   - ./server.key:/app/server.key:ro
    # command:
    #   - server
    #   - iroh
    #   - --allowed-tcp
    #   - "172.16.0.0/12"
    #   - --secret-file
    #   - /app/server.key
