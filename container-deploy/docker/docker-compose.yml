# Docker Compose example: Expose internal services via tunnel-rs (multi-source iroh mode)
#
# This example shows how to use tunnel-rs to expose services running in Docker
# to a remote peer without opening ports on the host.
#
# Multi-source mode: The client specifies which service to connect to.
# The server allows access to any service in the configured network ranges.
#
# Setup:
#   1. Generate server key for stable NodeId:
#      docker run --rm ghcr.io/andrewtheguy/tunnel-rs:latest \
#        generate-iroh-key --output - > server.key
#
#   2. Generate client key for authentication:
#      docker run --rm ghcr.io/andrewtheguy/tunnel-rs:latest \
#        generate-iroh-key --output - > client.key
#      docker run --rm -v ./client.key:/key:ro ghcr.io/andrewtheguy/tunnel-rs:latest \
#        show-iroh-node-id --secret-file /key
#      # Note the NodeId and add to clients.txt
#
#   3. Create clients.txt with allowed client NodeIds:
#      echo "<CLIENT_NODE_ID>" > clients.txt
#
#   4. Start the services:
#      docker compose up -d
#
#   5. Get the server NodeId from logs:
#      docker compose logs tunnel-server | grep NodeId
#
#   6. On the remote machine, connect to any service:
#      # Connect to web service
#      tunnel-rs client \
#        --server-node-id <SERVER_NODE_ID> \
#        --source tcp://web:80 \
#        --target 127.0.0.1:8080 \
#        --secret-file client.key
#
#      # Connect to database
#      tunnel-rs client \
#        --server-node-id <SERVER_NODE_ID> \
#        --source tcp://db:5432 \
#        --target 127.0.0.1:5432 \
#        --secret-file client.key
#
#   7. Access services at localhost

services:
  # Example web service
  web:
    image: nginx:alpine
    # No ports exposed - only accessible within Docker network

  # Example database service
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: example
    # No ports exposed - only accessible within Docker network

  # tunnel-rs server - exposes services to authenticated remote peers
  tunnel-server:
    image: ghcr.io/andrewtheguy/tunnel-rs:latest
    command:
      - server
      - --allowed-tcp
      - "172.16.0.0/12"  # Docker default network range
      - --allowed-tcp
      - "192.168.0.0/16" # Docker bridge networks
      - --secret-file
      - /secrets/server.key
      - --allowed-clients-file
      - /secrets/clients.txt
    volumes:
      - ./server.key:/secrets/server.key:ro
      - ./clients.txt:/secrets/clients.txt:ro
    depends_on:
      - web
      - db
