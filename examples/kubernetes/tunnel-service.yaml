# Kubernetes example: Expose cluster services via tunnel-rs
#
# Deploy tunnel-rs to expose internal ClusterIP services to remote peers.
# This is an alternative to kubectl port-forward that:
#   - Supports UDP (kubectl port-forward doesn't)
#   - Works across NAT without kubectl access
#   - Can be left running persistently
#
# Usage:
#   1. Create secrets for nostr keys:
#      kubectl create secret generic tunnel-nostr-keys \
#        --from-file=sender.nsec=./sender.nsec \
#        --from-literal=peer-npub=npub1...
#
#   2. Update the SERVICE_HOST below to your target service
#
#   3. Apply:
#      kubectl apply -f tunnel-service.yaml
#
#   4. On remote machine:
#      tunnel-rs receiver nostr \
#        --target tcp://127.0.0.1:5432 \
#        --nsec <YOUR_NSEC> \
#        --peer-npub <SENDER_NPUB>

apiVersion: v1
kind: ConfigMap
metadata:
  name: tunnel-config
data:
  # Target service to expose (ClusterIP service name)
  SERVICE_HOST: "postgres.default.svc.cluster.local"
  SERVICE_PORT: "5432"
  PROTOCOL: "tcp"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tunnel-sender
  labels:
    app: tunnel-sender
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tunnel-sender
  template:
    metadata:
      labels:
        app: tunnel-sender
    spec:
      containers:
        - name: tunnel
          image: ghcr.io/andrewtheguy/tunnel-rs:0.1.14
          command: ["/bin/sh", "-c"]
          args:
            - |
              tunnel-rs sender nostr \
                --source ${PROTOCOL}://${SERVICE_HOST}:${SERVICE_PORT} \
                --nsec-file /secrets/sender.nsec \
                --peer-npub $(cat /secrets/peer-npub)
          envFrom:
            - configMapRef:
                name: tunnel-config
          volumeMounts:
            - name: nostr-keys
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: nostr-keys
          secret:
            secretName: tunnel-nostr-keys

---
# Example: Expose a UDP service (e.g., WireGuard, DNS)
# This showcases tunnel-rs's advantage over kubectl port-forward
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tunnel-sender-udp
  labels:
    app: tunnel-sender-udp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tunnel-sender-udp
  template:
    metadata:
      labels:
        app: tunnel-sender-udp
    spec:
      containers:
        - name: tunnel
          image: ghcr.io/andrewtheguy/tunnel-rs:0.1.14
          args:
            - sender
            - nostr
            - --source
            - udp://coredns.kube-system.svc.cluster.local:53
            - --nsec-file
            - /secrets/sender.nsec
            - --peer-npub-file
            - /secrets/peer-npub
          volumeMounts:
            - name: nostr-keys
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: nostr-keys
          secret:
            secretName: tunnel-nostr-keys-udp
