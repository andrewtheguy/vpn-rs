# tunnel-rs-vpn server configuration example
#
# Usage: tunnel-rs-vpn server -c vpn_server.toml
#        tunnel-rs-vpn server --default-config
#
# CLI arguments take precedence over config file values.

# Required: validates config matches CLI command
role = "vpnserver"
mode = "iroh"

[iroh]
# ============================================================================
# VPN Network Configuration
# ============================================================================

# VPN network CIDR (REQUIRED)
# Clients will be assigned IPs from this network
network = "10.0.0.0/24"

# Server's VPN IP address (optional, defaults to first IP in network)
# This becomes the gateway for connected clients
# server_ip = "10.0.0.1"

# ============================================================================
# IPv6 Dual-Stack (Optional)
# ============================================================================
# Enable IPv6 alongside IPv4. When configured, clients receive both an IPv4
# and an IPv6 address. IPv6 is optional - IPv4-only configs continue to work.

# IPv6 VPN network CIDR (optional, enables dual-stack)
# Clients will be assigned IPs from this network (one /128 per client)
# network6 = "fd00::/64"

# Server's IPv6 VPN address (optional, defaults to first IP in network6)
# This becomes the IPv6 gateway for connected clients
# server_ip6 = "fd00::1"

# ============================================================================
# Performance Tuning
# ============================================================================

# MTU for VPN packets (576-1500, default: 1420)
# Lower values may help with fragmentation issues
mtu = 1420

# WireGuard keepalive interval in seconds (10-300, default: 25)
# keepalive_secs = 25

# ============================================================================
# Channel Buffer Sizes
# ============================================================================
# These control packet buffering between tasks. Valid range: 1-65536.

# Per-client outbound packet buffer (default: 1024)
# Controls how many packets can be queued for each client before backpressure/drops.
# Memory impact: client_channel_size * ~1500 bytes * connected_clients
# - 1024 (default): ~1.5 MB per client worst case
# client_channel_size = 1024

# TUN writer aggregate buffer (default: 512)
# Shared buffer for all client -> TUN traffic. Lower values bound memory usage.
# Memory impact: tun_writer_channel_size * ~1500 bytes
# - 512 (default): ~750 KB worst case (safe for memory-constrained hosts)
# - 2048-4096: Better burst tolerance for high-bandwidth servers
# tun_writer_channel_size = 512

# ============================================================================
# Backpressure Behavior
# ============================================================================

# What to do when a client's send buffer is full (default: false = apply backpressure)
#
# false (default): Apply backpressure by blocking the TUN reader until the slow
#                  client's buffer has space. This guarantees no packet loss.
#                  Best for development/homelab use where reliability matters.
#
# true:            Drop packets for slow clients. Prevents one slow client from
#                  blocking packet delivery to all other clients (head-of-line
#                  blocking). Best for real-time traffic like VoIP, gaming, or
#                  interactive sessions at scale where latency matters more than
#                  guaranteed delivery.
#
# drop_on_full = false

# ============================================================================
# Server Identity (Optional)
# ============================================================================

# Path to secret key file for persistent iroh identity
# Generates same EndpointId across restarts
# Create with: tunnel-rs-vpn generate-server-key -o ./vpn-server.key
# secret_file = "./vpn-server.key"

# ============================================================================
# Authentication (REQUIRED)
# ============================================================================
# At least one authentication method is required.
# Clients must provide one of these tokens to connect.
#
# Token format: exactly 18 characters (i + 16 body chars + Luhn mod N checksum)
# Generate with: tunnel-rs-vpn generate-token

# Inline tokens (for testing; prefer auth_tokens_file in production)
# NOTE: Use either auth_tokens OR auth_tokens_file, not both.
auth_tokens = ["iXXXXXXXXXXXXXXXXX"]  # Replace with real token from generate-token

# Or use a file containing tokens (one per line, # comments allowed)
# NOTE: Use either auth_tokens OR auth_tokens_file, not both.
# auth_tokens_file = "./vpn-tokens.txt"

# ============================================================================
# Relay and Discovery (Optional)
# ============================================================================

# Custom relay server URL(s) for failover
# Must match client's relay configuration for discovery
# relay_urls = [
#     "https://relay1.example.com",
#     "https://relay2.example.com",
# ]

# Custom DNS server URL for peer discovery
# Must match client's dns_server configuration
# NOTE: URL must include the /pkarr path
# dns_server = "https://dns.example.com/pkarr"

# ============================================================================
# Transport Tuning (Optional)
# ============================================================================
# Fine-tune QUIC transport layer for performance optimization.
# All values have sensible defaults - only configure if needed.

[iroh.transport]
# Congestion controller algorithm (default: cubic)
# - cubic: Loss-based, widely deployed, best for general internet
# - bbr: Model-based, may perform better on high-bandwidth/high-latency links
# - newreno: Classic TCP-like, most conservative
# congestion_controller = "cubic"

# QUIC receive window in bytes (default: 2097152 = 2MB)
# Controls flow control - larger values allow more in-flight data
# Valid range: 1024 (1KB) to 16777216 (16MB)
# receive_window = 2097152

# QUIC send window in bytes (default: 2097152 = 2MB)
# Controls how much data can be sent before acknowledgment
# Valid range: 1024 (1KB) to 16777216 (16MB)
# send_window = 2097152
